{% extends "MainPage.html" %}

{% block content %}

<section class="container py-5">

    <div class="row justify-content-center mb-4">
        <div class="col-lg-8 text-center">
            <h2 class="fw-bold" style="color:#166534;">
                Compare cryptocurrencies
            </h2>
            <p class="text-muted mb-0">
                Select two or more coins and see their market-cap movement
                over the last 30 days.
            </p>
        </div>
    </div>

    <!-- Форма за избор на повеќе coins -->
    <div class="row justify-content-center mb-4">
        <div class="col-lg-6">
            <form method="get" action="{{ url_for('compare_coins') }}">
                <label class="form-label fw-semibold" style="color:#166534;">
                    Choose coins to compare:
                </label>

                <!-- multiple select: name="symbols" за getlist("symbols") -->
                <select name="symbols" class="form-select" multiple size="8">
                    {% for sym in all_symbols %}
                        <option value="{{ sym }}"
                                {% if sym in selected_symbols %}selected{% endif %}>
                            {{ sym }}
                        </option>
                    {% endfor %}
                </select>

                <div class="form-text">
                    Hold Ctrl (Cmd on Mac) to select multiple.
                </div>

                <button type="submit"
                        class="btn mt-3 fw-semibold"
                        style="background-color:#16a34a; border:none; color:white;">
                    Compare
                </button>
            </form>
        </div>
    </div>

    <!-- График (само ако има избрани coins) -->
    {% if selected_symbols %}
    <div class="row justify-content-center">
        <div class="col-lg-10" style="height:420px;">
            <div class="card border-0 shadow-sm h-100" style="border-radius:1.25rem;">
                <div class="card-body" style="background-color:#ecfdf5;">
                    <canvas id="compare-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</section>

{% if selected_symbols %}
<script>
window.addEventListener('load', function () {
    const canvas = document.getElementById('compare-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    const series = {{ series | tojson }};
    const symbols = {{ selected_symbols | tojson }};

    if (!symbols.length) return;

    // најди прв симбол што има барем еден point
    let baseData = [];
    let baseSym = null;
    for (const sym of symbols) {
        if (series[sym] && series[sym].length) {
            baseData = series[sym];
            baseSym = sym;
            break;
        }
    }
    if (!baseData.length) {
        console.log("No data for selected coins in last 30 days.");
        return;
    }
    console.log("Using base series:", baseSym, "points:", baseData.length);

    // labels = датумите од базната серија
    const labels = baseData.map(point => point.date);

    // dataset за секој симбол
    const datasets = symbols.map(sym => {
        const points = series[sym] || [];
        const values = points.map(p => p.value ?? 0);

        return {
            label: sym,
            data: values,
            borderWidth: 2,
            tension: 0.25,
            fill: false
        };
    });

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Market cap'
                    }
                }
            }
        }
    });
});
</script>
{% endif %}

{% endblock %}
